# Perplexity Research Pipeline - Complete Setup Guide

## Overview

This n8n workflow automates the "Source Stack Method" for comprehensive research using Perplexity AI through OpenRouter. It runs three parallel queries (Expert Opinions, Recent Studies, Counterarguments) and combines results into structured research reports.

## Prerequisites

### Required Accounts & Services
1. **OpenRouter Account** - For Perplexity API access
2. **n8n Installation** - Self-hosted or n8n Cloud
3. **Google Cloud Console** - For Google Docs integration (optional)
4. **Notion Account** - For database storage (optional)
5. **Email Provider** - SMTP access for notifications (optional)

### Cost Considerations
- **OpenRouter API**: ~$0.015-0.03 per workflow run (3 queries Ã— ~1000 tokens)
- **Google Docs**: Free (within API quotas)
- **Notion**: Free for personal use
- **n8n**: Free self-hosted, $20/month for cloud

## Step 1: OpenRouter Setup

### Get Your API Key
1. Visit [OpenRouter.ai](https://openrouter.ai)
2. Create account and verify email
3. Go to **Keys** section in dashboard
4. Generate new API key
5. Copy and save securely

### Environment Variable Setup
In your n8n environment, add:
```bash
OPENROUTER_API_KEY=your_actual_api_key_here
```

**For n8n Cloud users:**
Settings > Environment Variables > Add Variable

**For self-hosted n8n:**
Add to your `.env` file or docker environment

## Step 2: Workflow Import

### Import Process
1. Copy the complete workflow JSON
2. In n8n: **Import from Clipboard**
3. Paste the workflow JSON
4. Click **Import**

### Initial Configuration
After import, update the **Set Research Parameters** node:
```json
{
  "research_topic": "Your research topic here",
  "openrouter_api_key": "={{$env.OPENROUTER_API_KEY}}"
}
```

## Step 3: Core Components Configuration

### HTTP Request Nodes (Required)
All three query nodes need:

**Headers:**
```
Authorization: Bearer {{$node["Set Research Parameters"].json["openrouter_api_key"]}}
Content-Type: application/json
```

**Body (JSON):**
```json
{
  "model": "perplexity/llama-3.1-sonar-large-128k-online",
  "messages": [
    {
      "role": "user", 
      "content": "Your query with {{topic}} placeholder"
    }
  ],
  "temperature": 0.3,
  "max_tokens": 1000
}
```

### Process Research Results Node
This JavaScript node combines all responses. No configuration needed - works automatically.

## Step 4: Output Configuration (Choose Your Options)

### Option A: Google Docs Integration

**Setup Google Cloud Console:**
1. Create new project at [Google Cloud Console](https://console.cloud.google.com)
2. Enable Google Docs API
3. Create OAuth2 credentials
4. Download credentials JSON

**Configure n8n Google Docs Node:**
1. Add Google OAuth2 credentials in n8n
2. Set document title template:
   ```
   Research Report: {{$node["Process Research Results"].json["topic"]}} - {{$now.format('YYYY-MM-DD')}}
   ```

### Option B: Notion Integration

**Setup Notion Integration:**
1. Go to [Notion Developers](https://developers.notion.com)
2. Create new integration
3. Copy Integration Token
4. Create database in Notion
5. Share database with your integration
6. Copy database ID from URL

**Configure n8n Notion Node:**
```json
{
  "databaseId": "your-database-id-here",
  "properties": {
    "Topic": "Text",
    "Date": "Date", 
    "Total Sources": "Number",
    "Status": "Select"
  }
}
```

### Option C: Simple File Output (Recommended for Testing)

Replace complex integrations with **Write Binary File** node:
```
File Name: research-{{$now.format('YYYY-MM-DD')}}.txt
Data: {{$node["Process Research Results"].json}}
```

## Step 5: Email Notifications (Optional)

### SMTP Configuration Options

**Gmail SMTP:**
```
Host: smtp.gmail.com
Port: 587
Username: your-email@gmail.com  
Password: your-app-password
```

**Outlook/Hotmail:**
```
Host: smtp-mail.outlook.com
Port: 587
Username: your-email@outlook.com
Password: your-password
```

### Email Template
```html
<!DOCTYPE html>
<html>
<body>
<h2>Research Pipeline Results</h2>
<p><strong>Topic:</strong> {{$node["Process Research Results"].json["topic"]}}</p>
<p><strong>Completed:</strong> {{$node["Process Research Results"].json["timestamp"]}}</p>

<h3>Summary</h3>
<ul>
<li>Expert Sources: {{$node["Process Research Results"].json["sources_count"]["expert_sources"]}}</li>
<li>Recent Studies: {{$node["Process Research Results"].json["sources_count"]["study_sources"]}}</li>
<li>Counter-arguments: {{$node["Process Research Results"].json["sources_count"]["counter_sources"]}}</li>
</ul>

<p><em>Generated by n8n Research Pipeline</em></p>
</body>
</html>
```

## Step 6: Testing & Deployment

### Test Workflow
1. **Manual Trigger:** Disable schedule, test manually first
2. **Single Query:** Test one HTTP request node first
3. **Check Logs:** Monitor n8n execution logs for errors
4. **Verify Output:** Confirm data structure in Process Results node

### Schedule Configuration
**Schedule Trigger Options:**
```json
{
  "pollTimes": {
    "item": [
      {"mode": "everyHour"},     // Hourly
      {"mode": "everyDay"},      // Daily at midnight  
      {"mode": "everyWeek"},     // Weekly
      {"mode": "custom", "cronExpression": "0 9 * * 1"}  // Mondays 9 AM
    ]
  }
}
```

## Troubleshooting

### Common Issues

**API Authentication Errors:**
- Verify OpenRouter API key is valid
- Check environment variable is set correctly
- Ensure proper Bearer token format

**Rate Limiting:**
- Add **Wait** nodes between HTTP requests (1-2 seconds)
- Reduce frequency of scheduled runs
- Monitor OpenRouter usage dashboard

**Memory Issues:**
- Reduce max_tokens in API calls
- Process results in smaller chunks
- Clear workflow history regularly

**Integration Failures:**
- Test external services separately
- Verify all credentials are current
- Check API quotas and limits

### Performance Optimization

**Cost Reduction:**
```json
{
  "temperature": 0.1,        // More consistent, cheaper
  "max_tokens": 800,         // Reduce if sufficient
  "model": "perplexity/llama-3.1-sonar-small-128k-online"  // Cheaper alternative
}
```

**Speed Improvements:**
- Use parallel HTTP requests (current setup)
- Implement result caching
- Add conditional logic to skip duplicate research

## Advanced Customization

### Custom Research Topics
Modify the **Set Research Parameters** node to accept dynamic topics:
```json
{
  "research_topic": "{{$json.topic}}",
  "research_depth": "{{$json.depth || 'standard'}}",
  "focus_area": "{{$json.focus || 'general'}}"
}
```

### Query Templates
Create specialized query templates:
```javascript
const templates = {
  business: "What do business leaders say about {topic}?",
  academic: "What does recent academic research show about {topic}?", 
  technical: "What are the technical implications of {topic}?",
  social: "What are the social impacts of {topic}?"
};
```

### Multi-Language Support
Add language parameter to queries:
```json
{
  "content": "Provide expert opinions on {{topic}} in {{language}} with sources"
}
```

## Security Best Practices

### API Key Management
- Never commit API keys to version control
- Use environment variables exclusively
- Rotate keys regularly
- Monitor usage dashboards

### Access Control
- Limit n8n access to authorized users
- Use webhook authentication for triggers
- Implement IP restrictions if possible
- Regular security audits

## Workflow Variations

### Quick Research Mode
- Single query instead of three
- Reduced token limits
- Faster execution time

### Deep Research Mode  
- Additional follow-up queries
- Higher token limits
- Citation analysis
- Source quality scoring

### Competitive Intelligence Mode
- Company-specific queries
- Market analysis focus
- Automated competitor monitoring
- Alert-based triggers

## Support Resources

### Documentation Links
- [OpenRouter API Docs](https://openrouter.ai/docs)
- [n8n Documentation](https://docs.n8n.io/)
- [Perplexity API Reference](https://docs.perplexity.ai/)

### Community Support
- n8n Community Forum
- OpenRouter Discord
- GitHub Issues (for this workflow)

### Professional Services
For custom implementations or enterprise deployments, consider:
- n8n Professional Services
- Custom automation consultants
- AI integration specialists

---

## License & Attribution

This workflow is open source. Attribution to Rahul Rawal appreciated but not required.

**Created by:** Rahul Rawal  
**Blog:** [Your Substack URL]  
**LinkedIn:** [Your LinkedIn Profile]  
**GitHub:** [Your GitHub Profile]  

---

*Last updated: [Current Date]*
*Version: 1.0*